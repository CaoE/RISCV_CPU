<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <link href="data:text/css;charset=utf-8,%0A%0Ahtml%20%7B%0Afont%2Dsize%3A%20100%25%3B%0Aoverflow%2Dy%3A%20scroll%3B%0A%2Dwebkit%2Dtext%2Dsize%2Dadjust%3A%20100%25%3B%0A%2Dms%2Dtext%2Dsize%2Dadjust%3A%20100%25%3B%0A%7D%0Abody%20%7B%0Acolor%3A%20%23444%3B%0Afont%2Dfamily%3A%20Georgia%2C%20Palatino%2C%20%27Palatino%20Linotype%27%2C%20Times%2C%20%27Times%20New%20Roman%27%2C%20serif%3B%0Afont%2Dsize%3A%2012px%3B%0Aline%2Dheight%3A%201%2E7%3B%0Apadding%3A%201em%3B%0Amargin%3A%20auto%3B%0Amax%2Dwidth%3A%2042em%3B%0Abackground%3A%20%23fefefe%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230645ad%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%230b0080%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%2306e%3B%0A%7D%0Aa%3Aactive%20%7B%0Acolor%3A%20%23faa700%3B%0A%7D%0Aa%3Afocus%20%7B%0Aoutline%3A%20thin%20dotted%3B%0A%7D%0A%2A%3A%3A%2Dmoz%2Dselection%20%7B%0Abackground%3A%20rgba%28255%2C%20255%2C%200%2C%200%2E3%29%3B%0Acolor%3A%20%23000%3B%0A%7D%0A%2A%3A%3Aselection%20%7B%0Abackground%3A%20rgba%28255%2C%20255%2C%200%2C%200%2E3%29%3B%0Acolor%3A%20%23000%3B%0A%7D%0Aa%3A%3A%2Dmoz%2Dselection%20%7B%0Abackground%3A%20rgba%28255%2C%20255%2C%200%2C%200%2E3%29%3B%0Acolor%3A%20%230645ad%3B%0A%7D%0Aa%3A%3Aselection%20%7B%0Abackground%3A%20rgba%28255%2C%20255%2C%200%2C%200%2E3%29%3B%0Acolor%3A%20%230645ad%3B%0A%7D%0Ap%20%7B%0Amargin%3A%201em%200%3B%0A%7D%0Aimg%20%7B%0Amax%2Dwidth%3A%20100%25%3B%0A%7D%0Ah1%2C%20h2%2C%20h3%2C%20h4%2C%20h5%2C%20h6%20%7B%0Acolor%3A%20%23111%3B%0Aline%2Dheight%3A%20125%25%3B%0Amargin%2Dtop%3A%202em%3B%0Afont%2Dweight%3A%20normal%3B%0A%7D%0Ah4%2C%20h5%2C%20h6%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Ah1%20%7B%0Afont%2Dsize%3A%202%2E5em%3B%0A%7D%0Ah2%20%7B%0Afont%2Dsize%3A%202em%3B%0A%7D%0Ah3%20%7B%0Afont%2Dsize%3A%201%2E5em%3B%0A%7D%0Ah4%20%7B%0Afont%2Dsize%3A%201%2E2em%3B%0A%7D%0Ah5%20%7B%0Afont%2Dsize%3A%201em%3B%0A%7D%0Ah6%20%7B%0Afont%2Dsize%3A%200%2E9em%3B%0A%7D%0Ablockquote%20%7B%0Acolor%3A%20%23666666%3B%0Amargin%3A%200%3B%0Apadding%2Dleft%3A%203em%3B%0Aborder%2Dleft%3A%200%2E5em%20%23EEE%20solid%3B%0A%7D%0Ahr%20%7B%0Adisplay%3A%20block%3B%0Aheight%3A%202px%3B%0Aborder%3A%200%3B%0Aborder%2Dtop%3A%201px%20solid%20%23aaa%3B%0Aborder%2Dbottom%3A%201px%20solid%20%23eee%3B%0Amargin%3A%201em%200%3B%0Apadding%3A%200%3B%0A%7D%0Apre%2C%20code%2C%20kbd%2C%20samp%20%7B%0Acolor%3A%20%23000%3B%0Afont%2Dfamily%3A%20monospace%2C%20monospace%3B%0A%5Ffont%2Dfamily%3A%20%27courier%20new%27%2C%20monospace%3B%0Afont%2Dsize%3A%200%2E98em%3B%0A%7D%0Apre%20%7B%0Awhite%2Dspace%3A%20pre%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%0Aword%2Dwrap%3A%20break%2Dword%3B%0A%7D%0Ab%2C%20strong%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Adfn%20%7B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0Ains%20%7B%0Abackground%3A%20%23ff9%3B%0Acolor%3A%20%23000%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Amark%20%7B%0Abackground%3A%20%23ff0%3B%0Acolor%3A%20%23000%3B%0Afont%2Dstyle%3A%20italic%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Asub%2C%20sup%20%7B%0Afont%2Dsize%3A%2075%25%3B%0Aline%2Dheight%3A%200%3B%0Aposition%3A%20relative%3B%0Avertical%2Dalign%3A%20baseline%3B%0A%7D%0Asup%20%7B%0Atop%3A%20%2D0%2E5em%3B%0A%7D%0Asub%20%7B%0Abottom%3A%20%2D0%2E25em%3B%0A%7D%0Aul%2C%20ol%20%7B%0Amargin%3A%201em%200%3B%0Apadding%3A%200%200%200%202em%3B%0A%7D%0Ali%20p%3Alast%2Dchild%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Aul%20ul%2C%20ol%20ol%20%7B%0Amargin%3A%20%2E3em%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dbottom%3A%201em%3B%0A%7D%0Adt%20%7B%0Afont%2Dweight%3A%20bold%3B%0Amargin%2Dbottom%3A%20%2E8em%3B%0A%7D%0Add%20%7B%0Amargin%3A%200%200%20%2E8em%202em%3B%0A%7D%0Add%3Alast%2Dchild%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Aimg%20%7B%0Aborder%3A%200%3B%0A%2Dms%2Dinterpolation%2Dmode%3A%20bicubic%3B%0Avertical%2Dalign%3A%20middle%3B%0A%7D%0Afigure%20%7B%0Adisplay%3A%20block%3B%0Atext%2Dalign%3A%20center%3B%0Amargin%3A%201em%200%3B%0A%7D%0Afigure%20img%20%7B%0Aborder%3A%20none%3B%0Amargin%3A%200%20auto%3B%0A%7D%0Afigcaption%20%7B%0Afont%2Dsize%3A%200%2E8em%3B%0Afont%2Dstyle%3A%20italic%3B%0Amargin%3A%200%200%20%2E8em%3B%0A%7D%0Atable%20%7B%0Amargin%2Dbottom%3A%202em%3B%0Aborder%2Dbottom%3A%201px%20solid%20%23ddd%3B%0Aborder%2Dright%3A%201px%20solid%20%23ddd%3B%0Aborder%2Dspacing%3A%200%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Apadding%3A%20%2E2em%201em%3B%0Abackground%2Dcolor%3A%20%23eee%3B%0Aborder%2Dtop%3A%201px%20solid%20%23ddd%3B%0Aborder%2Dleft%3A%201px%20solid%20%23ddd%3B%0A%7D%0Atable%20td%20%7B%0Apadding%3A%20%2E2em%201em%3B%0Aborder%2Dtop%3A%201px%20solid%20%23ddd%3B%0Aborder%2Dleft%3A%201px%20solid%20%23ddd%3B%0Avertical%2Dalign%3A%20top%3B%0A%7D%0A%2Eauthor%20%7B%0Afont%2Dsize%3A%201%2E2em%3B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%40media%20only%20screen%20and%20%28min%2Dwidth%3A%20480px%29%20%7B%0Abody%20%7B%0Afont%2Dsize%3A%2014px%3B%0A%7D%0A%7D%0A%40media%20only%20screen%20and%20%28min%2Dwidth%3A%20768px%29%20%7B%0Abody%20%7B%0Afont%2Dsize%3A%2016px%3B%0A%7D%0A%7D%0A%40media%20print%20%7B%0A%2A%20%7B%0Abackground%3A%20transparent%20%21important%3B%0Acolor%3A%20black%20%21important%3B%0Afilter%3A%20none%20%21important%3B%0A%2Dms%2Dfilter%3A%20none%20%21important%3B%0A%7D%0Abody%20%7B%0Afont%2Dsize%3A%2012pt%3B%0Amax%2Dwidth%3A%20100%25%3B%0A%7D%0Aa%2C%20a%3Avisited%20%7B%0Atext%2Ddecoration%3A%20underline%3B%0A%7D%0Ahr%20%7B%0Aheight%3A%201px%3B%0Aborder%3A%200%3B%0Aborder%2Dbottom%3A%201px%20solid%20black%3B%0A%7D%0Aa%5Bhref%5D%3Aafter%20%7B%0Acontent%3A%20%22%20%28%22%20attr%28href%29%20%22%29%22%3B%0A%7D%0Aabbr%5Btitle%5D%3Aafter%20%7B%0Acontent%3A%20%22%20%28%22%20attr%28title%29%20%22%29%22%3B%0A%7D%0A%2Eir%20a%3Aafter%2C%20a%5Bhref%5E%3D%22javascript%3A%22%5D%3Aafter%2C%20a%5Bhref%5E%3D%22%23%22%5D%3Aafter%20%7B%0Acontent%3A%20%22%22%3B%0A%7D%0Apre%2C%20blockquote%20%7B%0Aborder%3A%201px%20solid%20%23999%3B%0Apadding%2Dright%3A%201em%3B%0Apage%2Dbreak%2Dinside%3A%20avoid%3B%0A%7D%0Atr%2C%20img%20%7B%0Apage%2Dbreak%2Dinside%3A%20avoid%3B%0A%7D%0Aimg%20%7B%0Amax%2Dwidth%3A%20100%25%20%21important%3B%0A%7D%0A%40page%20%3Aleft%20%7B%0Amargin%3A%2015mm%2020mm%2015mm%2010mm%3B%0A%7D%0A%40page%20%3Aright%20%7B%0Amargin%3A%2015mm%2010mm%2015mm%2020mm%3B%0A%7D%0Ap%2C%20h2%2C%20h3%20%7B%0Aorphans%3A%203%3B%0Awidows%3A%203%3B%0A%7D%0Ah2%2C%20h3%20%7B%0Apage%2Dbreak%2Dafter%3A%20avoid%3B%0A%7D%0A%7D" rel="stylesheet" type="text/css" />
</head>
<body>
<h1 id="riscv-cpu">RISCV-CPU</h1>
<p>This is a project of Computer System class of ACM honor class in SJTU.</p>
<p>Copyright (c) 2017 Zhanghao Wu</p>
<h2 id="abstract">Abstract</h2>
<p>This project is a simple five stage pipelined cpu for risc-v (rv32i) written in verilog HDL.</p>
<p>It has features as follows:</p>
<ol style="list-style-type: decimal">
<li><p>It can behave correctly for the instructions in rv32i, except ECALL, EBREAK, CSRRW, CSRRS, CSRRC, CSRRWI, CSRRSI, CSRRCI</p></li>
<li><p>It has a cache on board and a uart module to link the cpu to the memory simulator on PC.</p></li>
<li><p>It has exciting light and status indicator. RGB!!!</p></li>
</ol>
<h2 id="introduction">Introduction</h2>
<p>The data and control flow are in the graph below.</p>
<h3 id="five-stge-pipline">Five stge pipline</h3>
<p>The pipeline is similar to the standard mips five stage pipeline with forwardings. For more information, you can read the <a href="#ref1">Reference [1]</a>.</p>
<h3 id="forwarding">Forwarding</h3>
<p>Just as the graph above shows, each stage after ID has a wire connecting to it, to forward the data back. And in this design, ID stage can get the data in the same cpu cycle.</p>
<h3 id="jumps-and-branches">Jumps and Branches</h3>
<p>To get a better trade off of jumps and the clock rate, I tried a lot methods. And my work can be divided into 2 stages, no-memory-delay and great-memory-delay.</p>
<ol style="list-style-type: decimal">
<li>In my disgn, there are some wires from ID and EX to pc_reg and mid stage -- IF_ID and ID_EX, in order to set new address and clear the former instruction ( presice interrupt ).
<ul>
<li>no-memory-delay: PC_reg and mid stage update their status as soon as the signal reach, which works well when the IF stage never stall.</li>
<li>great-memory-delay: In this case the pc_reg and mid stages are disgned as state machine, when they get a signal for jump, they get into another state to save the signal.</li>
</ul></li>
<li>I add switches for <em>ID_BRANCHES</em> and <em>ID_JALR</em>, indicating that the in which state the branches and jalr should be executed.
<ul>
<li>Firstly, the JAL can be safely executed at ID stage. And the other branches and jumps can be set at ID stage, when the IF stage will never stall.</li>
<li>However, as the branch instruction needs data from regeisters which may be forwarded from the stage after ID. More comparation and addition will make ID take more time, and that can be a bottle neck that make the CPU clock rate much slower.</li>
<li>Another reason I put the all of the execution of branches, execpt jal, to EX stage is that, when the IF and ME should stall for some cycles, and the pc_reg and mid stage should save the signal, the time for ID to get the forwarding data will be much longer, ID may give wrong branch signal before the needed data reach.</li>
<li>Further more, when the branches are set in EX, we can use branch prediction in ID, to speed up our pipeline (uncompleted).</li>
</ul>
PS: Branches in EX, without branch prediction can be regarded as always predict not jump, when the instruction is recogonized by ID.</li>
</ol>
<h3 id="if-and-me">IF and ME</h3>
<p>As the cache will give a done signal when the data is ready and the signal only last for one cycle, the logical to wait for the cache to be done can be quite simple and amazing. ( In IF.v and ME.v you can see the code ).</p>
<h3 id="the-cache">The cache</h3>
<h3 id="makefile-for-test-generation">Makefile for test generation</h3>
<p>I write a makefile for make, which can make both .s and .cpp/.c files by using the riscv-tool-chain. The guidance for using it is in <a href="https://gist.github.com/Michaelvll/46e069e29a8448326acadd7bb2bb1654">Makefile for risc v tool chain</a>.</p>
<ol style="list-style-type: decimal">
<li><p>The imm in sltiu command is signed extended, and unsigned compared.</p></li>
<li><p>The aluop is firstly numbered by the opcode+funct3+(funct7?), then it is renumbered by the sequence: 0x1,0x2,..., to make the number shorter for better performance.</p></li>
</ol>
<h2 id="support-isa">Support ISA</h2>
<p>Now this project support almost all of the commands in rv32i. The suppoted commands are listed in the <a href="#ApdxA">Appendix A</a></p>
<h2 id="qa">Q&amp;A</h2>
<ol style="list-style-type: decimal">
<li>Why op_imm, like xori command doesn't support imm larger than 0x7ff such as 0x801?</li>
</ol>
<ul>
<li>Because the imm is signed.</li>
</ul>
<h2 id="reference">Reference</h2>
<ol style="list-style-type: decimal">
<li><span id="ref1"><a href="https://github.com/jmahler/mips-cpu.git">A MIPS CPU written in Verilog by jmahler</a></span></li>
<li><a href="www-inst.eecs.berkeley.edu/~cs150/sp13/resources/Always.pdf">Always@</a></li>
<li>《自己动手写CPU》雷思磊</li>
<li><a href="https://github.com/sxtyzhangzk/mips-cpu.git">A Mips CPU written in verilog by sxtyzhangzk</a></li>
</ol>
<h2 id="appendix">Appendix</h2>
<h3 id="a.-suppoted-commands"><span id="ApdxA">A. Suppoted commands</span></h3>
<table>
<thead>
<tr class="header">
<th>Command</th>
<th>Support</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>LUI</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>AUIPC</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>JAL</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>JALR</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>BEQ</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>BNE</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>BLT</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>BGE</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>BLTU</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>BGEU</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>LB</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>LH</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>LW</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>LBU</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>LHU</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>SB</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>SH</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>SW</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>ADDI</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>SLTI</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>SLTIU</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>XORI</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>ORI</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>ANDI</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>SLLI</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>SRLI</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>SRAI</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>ADD</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>SUB</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>SLL</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>SLT</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>SLTU</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>XOR</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>SRL</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>SRA</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>OR</td>
<td>[O]</td>
</tr>
<tr class="odd">
<td>AND</td>
<td>[O]</td>
</tr>
<tr class="even">
<td>Fence</td>
<td>[X]</td>
</tr>
<tr class="odd">
<td>Fence.I</td>
<td>[X]</td>
</tr>
<tr class="even">
<td>ECALL</td>
<td>[X]</td>
</tr>
<tr class="odd">
<td>EBREAK</td>
<td>[X]</td>
</tr>
<tr class="even">
<td>CSRRW</td>
<td>[X]</td>
</tr>
<tr class="odd">
<td>CSRRS</td>
<td>[X]</td>
</tr>
<tr class="even">
<td>CSRRC</td>
<td>[X]</td>
</tr>
<tr class="odd">
<td>CSRRWI</td>
<td>[X]</td>
</tr>
<tr class="even">
<td>CSRRSI</td>
<td>[X]</td>
</tr>
<tr class="odd">
<td>CSRRCI</td>
<td>[X]</td>
</tr>
</tbody>
</table>
</body>
</html>
